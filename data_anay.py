import pickle
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

#todo update baseline
base_line = [4037.171753852843, 3483.807233497144, 3555.0100440657484, 4459.082849947641, 3915.5163844573567, 3909.368315749098, 3623.7831549839393, 3902.362489570932, 4044.303461011181, 3826.545339646406, 3790.1812722598543, 3617.941526418297, 3654.89199775073, 3248.495085419257, 3412.088977621384, 3446.965286945219, 3799.896324302686, 3442.8316108465824, 3461.9525311809316, 3842.9978882490855, 3558.073782622354, 3567.5645346116303, 2999.9733868472176, 3643.916556743158, 4032.440524747133, 3691.922249098971, 3417.0865745772544, 3517.8907986178706, 3913.9868256431814, 3844.515830493382, 3429.561838332569, 4308.777708935629, 3526.812948774822, 3650.028991999429, 3541.239209135504, 3478.757096044292, 4067.568097186024, 4189.395331625904, 3587.7979496362664, 4224.347891625318, 3679.534742967019, 4018.591867530379, 3696.28943780665, 4041.5176146761883, 3553.0704722846654, 3715.0077312531294, 3374.988291330775, 4540.651697183246, 3495.3182975486566, 3718.9349428847177, 3867.2141608120223, 3752.4078735106837, 3658.9278378047684, 3530.205878548219, 3903.003205518776, 3748.3310944869845, 3296.15533838479, 3468.9391999676905, 4054.4763810763807, 3939.8471977816844, 3774.128234911153, 4065.484464343983, 3990.583967597368, 3492.090732932527, 3417.9606586839805, 4201.878298204456, 3487.1929319187993, 3407.9203620766734, 3972.626178831139, 3993.7961873117406, 3525.8844088280616, 3707.754582612287, 3628.747425198469, 4304.051177931513, 3962.4419493312676, 3247.4324872368666, 3771.592879882168, 3790.6864791842645, 3787.5938392442263, 4362.082603324186, 3586.0195466714226, 3798.03443134273, 3994.3316971973877, 3479.463548255164, 3504.739737810235, 3920.884018413138, 4136.610831396485, 4489.354659347564, 3930.2565210630196, 4308.505109128333, 3331.577680373772, 4018.4811196997657, 3595.6179839783213, 3733.2195430307775, 3650.008996802025, 3794.6897447630263, 3728.8448185975167, 3890.1241000223004, 4327.358510543994, 3595.7118364384105]
#base_line_default = [3640.207932470713, 3259.471158561774, 3272.967779233075, 3980.4744872878205, 3654.441117002636, 3617.552524992199, 3385.7266436194973, 3633.7259900370645, 3701.319789924607, 3547.5532413373853, 3535.444859379403, 3363.9767127573114, 3409.4330105539216, 3026.160397466552, 3185.154310719992, 3223.056152398053, 3545.681002003613, 3205.4464976074646, 3233.356108677415, 3589.849949353045, 3328.8675982925065, 3164.5388440892975, 2810.6178525926907, 3402.2609619366563, 3756.1033712794333, 3443.6665603236956, 3193.6436054387464, 3286.9338138385415, 3647.7625860053677, 3580.57473896449, 3192.3520985267833, 4021.8978832146, 3284.035961170833, 3420.372623768788, 3314.842522617002, 3245.3025621165443, 3794.9449034952404, 3733.9731297896183, 3348.2003241626794, 3931.694252448358, 3435.211944407357, 3749.4222320515983, 3449.660711419475, 3770.6789736554438, 3322.5917554985954, 3468.0899935959083, 3004.618943660049, 4235.966484283537, 3261.5167798206808, 3474.978357746871, 3600.6404929206155, 3451.4033158600055, 3419.136159494497, 3293.737743146157, 3642.775563815982, 3503.2999624742984, 3073.28929302472, 3242.1654101919553, 3774.675637151649, 3677.4216772337672, 3520.8185400174048, 3790.8406684769034, 3532.317717027929, 3254.55499525551, 3181.117919407197, 3746.358257095867, 3252.0568800464052, 3018.8440755296206, 3711.761336639868, 3721.2678516917836, 3148.2808680028234, 3460.2717503514727, 3386.994679106415, 3944.6241506115834, 3615.7672754950268, 3038.069940436667, 3516.5807876941126, 3460.937563245193, 3531.78189318312, 3858.087727374902, 3343.8349039812497, 3544.0475914235776, 3726.8255175945433, 3238.484904220372, 3263.5581982977824, 3620.6402981654046, 3842.2860186257103, 4177.6118582158015, 3660.4983335793886, 4010.8015116092256, 3036.6345584351043, 3678.948672671008, 3358.971776864502, 3479.673698087123, 3410.790460980009, 3536.658324269678, 3471.63386522965, 3622.9003326200695, 4019.760126236593, 3353.2468445084974]
#base_line_default = [3640.1980684413716, 3259.4711585617865, 3272.967779233131, 3980.474487287839, 3654.441117002572, 3617.5525249925813, 3385.7266436194377, 3633.725990037118, 3701.319789924527, 3547.5532413363026, 3535.4448593794937, 3363.9767127573364, 3409.433010553866, 3026.1603974665986, 3185.154310720058, 3223.0561523979095, 3545.681002003543, 3205.446497607673, 3233.356108677372, 3589.849949353086, 3328.8675982925633, 3164.5388440892616, 2810.6178525927, 3402.2609619367204, 3756.1033712793924, 3443.6665603237293, 3193.643605438729, 3286.933813838544, 3647.762586005391, 3580.574738964467, 3192.3520985268106, 4021.89788321459, 3284.035961170881, 3420.37262376875, 3314.842522617053, 3245.302562116511, 3794.944903495237, 3733.9731297896556, 3348.2003241625152, 3931.694252448392, 3435.211944407333, 3749.422232051492, 3449.660711419541, 3770.6789736554247, 3322.591755498687, 3468.089993595874, 3004.618943659392, 4235.966484283474, 3261.5167798205766, 3474.9783577468966, 3600.640492920532, 3451.4033158597304, 3419.136159494464, 3293.7377431461805, 3642.77556381599, 3503.2999624742783, 3073.289293024666, 3242.1654101920076, 3774.675637151663, 3677.4216772337777, 3520.818540017447, 3790.840668476844, 3532.3177170272734, 3254.554995255509, 3181.117919407239, 3746.3582570958074, 3252.0568800463084, 3018.844075529698, 3711.7613366398873, 3721.2678516918286, 3148.2808680027842, 3460.271750351474, 3386.994679106435, 3944.624150611255, 3615.767275494962, 3038.069940436688, 3516.5807876940785, 3460.9375632451934, 3531.7818931830393, 3858.0877273749206, 3343.834903981304, 3544.0475914236863, 3726.825517594458, 3238.484904220382, 3263.558198297761, 3620.6402981654555, 3842.2860186257644, 4177.611858215785, 3660.498333579446, 4010.8015116090805, 3036.6345584350775, 3678.948672671275, 3358.971776864656, 3479.6736980870937, 3410.7904609800016, 3536.6583242697225, 3471.6338652297463, 3622.900332620095, 4019.7601262366748, 3353.24684450847]
base_line_default_new = [3640.120879514329, 3259.460569834325, 3288.9427256492795, 3984.0604755678273, 3654.450561741855, 3619.7155690125237, 3385.9845973194333, 3634.029233601022, 3696.5917917583165, 3548.0402920283673, 3535.310959982878, 3363.7436528059948, 3410.0513618799023, 3026.7970529152713, 3185.191449314093, 3223.024071552003, 3546.034153557699, 3207.5344427146756, 3236.434609907787, 3589.7079000800486, 3328.666870313679, 3164.3571569095466, 2813.101454557507, 3404.9336898455817, 3757.347410347902, 3443.6348680758692, 3193.6858695956953, 3285.3857101302024, 3648.517209852531, 3579.1621775083963, 3192.4492923938037, 4026.8806851203262, 3283.80666392492, 3421.0082600845485, 3315.056968737724, 3244.9776662043146, 3794.1479542887027, 3737.576346810587, 3347.9329635300114, 3932.1338044801664, 3434.548181448003, 3749.3640742949574, 3448.980044350599, 3770.380791045411, 3322.4501328326737, 3468.0357975116185, 3003.058509752813, 4248.330678404973, 3261.8686884683016, 3475.797324652345, 3600.5355892158905, 3450.551825071359, 3418.3841431972583, 3293.5881863346367, 3642.926976507736, 3503.35400342057, 3073.237301980557, 3244.2689867559943, 3775.0920340685875, 3677.25745475553, 3520.695112929852, 3791.613367886829, 3532.609029287034, 3253.761353401045, 3181.258363981852, 3719.52701186465, 3251.610170907615, 3020.7818363564948, 3715.865048064278, 3721.6895237830286, 3148.4707569659267, 3460.512531613406, 3387.5019026917234, 3945.205901997076, 3617.2896536919156, 3038.075096800153, 3518.2548210108416, 3461.8086932016768, 3531.781383973618, 3860.1891037128757, 3344.2909913450553, 3544.5775943587587, 3727.0898525452817, 3238.697717511432, 3265.239473448771, 3623.454089409099, 3842.094475705602, 4177.875120284098, 3660.3066323359426, 4010.697968123308, 3051.7996804682716, 3680.0908201872894, 3358.862309302115, 3480.0576806649783, 3410.7770539291487, 3536.640602353784, 3471.7142076435957, 3624.135576080775, 4018.030902980416, 3353.522649026378]
base_line_1st= [4018.840383198584, 3468.866447843211, 3541.291587814067, 4459.19784786555, 3893.069546210997, 3891.122520206708, 3602.2235016710024, 3881.1696658316737, 4029.203830304424, 3809.5857705399517, 3769.446755588938, 3598.8264652359558, 3637.418939098623, 3231.715684472745, 3393.6813648123907, 3431.475787649768, 3785.601974378385, 3428.999200458524, 3448.775872997732, 3825.5109886228597, 3538.238141004725, 3612.1833250363534, 2991.2062737689266, 3630.4223500057733, 4015.4615635538885, 3674.4258488646315, 3400.2317150989816, 3496.537432253492, 3896.329711407611, 3823.7590781218832, 3411.333443641423, 4299.312459881699, 3509.0561177095424, 3631.404934567975, 3520.0215291798604, 3459.924720397731, 4046.624812949464, 4178.549169229467, 3568.8042800194785, 4203.6691524019125, 3663.025465475967, 3997.4805062648834, 3676.1254660048417, 4024.786214740342, 3535.927216753488, 3697.739038751432, 3373.910203641429, 4528.671920635423, 3475.5057767500643, 3698.916943607022, 3846.063676319461, 3733.6390454633797, 3638.1371897511676, 3513.1896472835056, 3882.70648091331, 3727.3263838810603, 3278.700944445909, 3458.1520100061953, 4035.3734193249174, 3920.5873213916957, 3754.8899054801077, 4045.3300506645364, 4003.651818233557, 3475.926486708081, 3401.363824628357, 4193.792766934023, 3470.3616564013314, 3493.313889380462, 3957.8455026612014, 3969.7429536405907, 3567.405018661351, 3691.7517543709473, 3610.2714595733387, 4285.0903288310365, 3941.9549157055894, 3230.157582984844, 3754.9437514767615, 3773.505813405918, 3766.631121379967, 4388.201848483584, 3567.655806027672, 3779.3562317582996, 3975.2645431891838, 3462.498553468593, 3490.6554668409535, 3907.8045906752473, 4116.165927929753, 4466.489605429854, 3910.801173011585, 4287.0634239150895, 3315.3317161422647, 4004.6755175260523, 3577.896272080793, 3715.8893420911777, 3634.75312055551, 3778.2033675658436, 3714.2324134587902, 3877.8713005276295, 4307.449310746244, 3579.022337123486]
base_100_top1 = [3831.933888490004, 3320.703474202255, 3372.3756734770163, 4246.7486695503185, 3720.396988113281, 3718.3796133594865, 3448.0941934873367, 3699.6498230514803, 3839.114624343361, 3639.5408413587893, 3599.378527765617, 3430.745148342086, 3474.5207469374814, 3092.6004667888783, 3243.2781238885827, 3278.0498469136414, 3607.212963601739, 3277.0047632138117, 3296.569728629744, 3653.380702354793, 3386.3285553899645, 3445.6132723601877, 2863.3091281665447, 3465.3513976461622, 3830.305737989307, 3506.1683708898845, 3249.38579441106, 3341.899924517572, 3714.9988617931076, 3645.290161839263, 3252.5408627976303, 4093.142323530723, 3351.850105286606, 3477.9990734404632, 3374.0718312751223, 3303.6342074887166, 3864.532565710902, 3989.5308858694316, 3409.3646484405126, 4004.2072862264727, 3498.924968575455, 3817.94891990517, 3508.8934958562118, 3841.090308407304, 3380.143902180182, 3530.263528275318, 3218.6261284028865, 4326.401861583241, 3320.378833070835, 3540.5214745885605, 3668.291020135734, 3567.603037115355, 3479.7373001386727, 3353.783806483033, 3708.4935899249226, 3563.807334583179, 3130.246511035802, 3300.360680262197, 3844.3885940089135, 3748.556393330201, 3586.305711424598, 3858.416224243761, 3817.9061117849064, 3318.2317654241647, 3242.437876089376, 4001.9464245290374, 3310.962694174106, 3339.759961505011, 3780.5501129728423, 3789.8649283677546, 3405.544488861594, 3521.9190610212695, 3451.812263808627, 4090.6251965264273, 3764.4375722320087, 3092.781168776316, 3582.339735339186, 3607.8686276691824, 3593.5066912306484, 4185.609697917013, 3405.2372627162945, 3609.5451744763, 3792.9332273412624, 3302.198082169868, 3325.0933149853977, 3733.6994016165027, 3927.7344456715778, 4250.7572072946905, 3728.480168388379, 4084.6496027354874, 3172.7998495906754, 3821.1166242020763, 3420.131916656385, 3542.8946084137892, 3470.2104325274017, 3599.6584935488318, 3535.4427822537814, 3690.495608369452, 4104.5352376783285, 3415.9710703157557]
base_100_top1_38 = [3905.1936576344497, 3377.842092725043, 3434.4727883469627, 4319.778784525831, 3790.399464629267, 3780.28231671579, 3509.0228099906144, 3772.4133244532322, 3911.1821191777694, 3701.415619093746, 3666.5235927313256, 3494.695894055047, 3533.2415075611466, 3132.0606191929924, 3301.4129673175557, 3339.569781016462, 3678.185075540949, 3336.85828110799, 3347.7514250534387, 3717.445491106022, 3445.124495684873, 3510.322903910823, 2909.825080068757, 3527.3626001866382, 3897.8847553588444, 3570.7544744779957, 3308.367569847319, 3394.3724847413137, 3785.7868459178612, 3716.3263490944523, 3313.7541816645094, 4171.147902679206, 3411.7670425048964, 3537.3358917454325, 3434.4239265858437, 3368.1529971441214, 3933.9390538228417, 4065.504462659656, 3471.6889136376785, 4083.575631257152, 3564.449191907045, 3890.0400023753, 3574.6430004697945, 3907.1256234657644, 3440.886135274297, 3596.2606244603917, 3280.5310643351036, 4384.851719438511, 3381.861265538177, 3596.489033629412, 3741.82193600988, 3627.920526923126, 3542.8491102105395, 3417.4939451893406, 3779.698304862487, 3628.2499911791633, 3188.237893469684, 3363.6602724693257, 3920.2005818339258, 3812.484817152171, 3652.9837220893423, 3935.2267773118783, 3891.420606113805, 3371.074170347681, 3304.0192569971387, 4074.6669258783963, 3371.0379297797995, 3394.752401380381, 3845.5207989536134, 3864.942486859782, 3464.8151791294117, 3587.661352830772, 3512.1738381433934, 4165.276182927098, 3836.8211730625803, 3148.992785914181, 3651.1657250269413, 3669.190742502538, 3662.7923218035394, 4260.518737626107, 3467.300325390399, 3677.901187501716, 3864.486881182099, 3363.5870061753244, 3384.3135173784835, 3796.3172070247238, 4003.958865216923, 4338.255861405231, 3795.122944278879, 4169.2300161327985, 3228.5923903747203, 3885.0413433806943, 3480.8710686603486, 3606.7428295296795, 3533.137851770374, 3666.1832257230353, 3597.703291463025, 3755.812720822198, 4182.86821865084, 3471.4261428810933]

# imps = []
#
# for seed in range(1, 101):
#     with open(f'100_2nd_layer_{seed}_office_yield', 'rb') as fp:
#         yields = pickle.load(fp)
#         yields = [-y for y in yields]
#         imp = (np.mean(yields) - base_line_default_new[seed - 1]) / base_line_default_new[seed - 1]
#         imps.append(imp)

imps = [(x-y)/y for x,y in zip(base_100_top1_38, base_line_default_new)]

# print(np.mean(imps))
# print(np.std(imps))
# print(np.min(imps))
# print(np.max(imps))
# exit()
term1 = (np.mean(imps) + np.median(imps))/2
term2 = (np.std(imps) + (np.percentile(imps, 75) - np.percentile(imps, 25)) / 2) / 2
print(f'{np.round(term1 * 100, 2)}% +- {np.round(term2 * 100, 2)}%')


# sns.distplot(imps, hist=True, label=f'{np.round(term1 * 100, 2)}% +- {np.round(term2, 2)}')

# sns.distplot(imps, hist=False, kde=True,
#              kde_kws={'linewidth': 3, 'shade': True},
#              label=f'{np.round(term1 * 100, 2)}% +- {np.round(term2, 2)}')

import pandas as pd
pd.Series(imps).hist(bins=100)

plt.legend([f'{np.round(term1 * 100, 2)}% +- {np.round(term2 * 100, 2)}%'])
plt.yticks([])
plt.title('Penicillin Yield Improvements')
plt.xlabel('Improvement Percentage')
plt.ylabel('Density')
plt.show()

# with open('1000_opt_1000_baseline.pkl', 'rb') as fp:
#     yields = pickle.load(fp)
#
# print(yields[0]['yields'])
# imps = []
# for seed in range(1, 21):
#     with open('1000_opt_1000_baseline.pkl', 'rb') as fp:
#         yields = pickle.load(fp)
#         yields = yields[seed]['yields']
#         imp = (np.mean(yields) - 3997) / 3997
#         imps.append(imp)
#
# print(imps)

# new_yields = [-ele for ele in new_yields]
# print(len(new_yields))
#
# print(f"=== mean: {np.mean(new_yields)}")
# print(f"=== std: {np.std(new_yields)}")
# print(f"=== min: {np.min(new_yields)}")
# print(f"=== max: {np.max(new_yields)}")
#
# plt.plot(new_yields)
# plt.show()
